DROP TABLE IF EXISTS `appointments`;
CREATE TABLE `appointments` (
  `id` varchar(255) NOT NULL,
  `serviceId` varchar(255) NOT NULL,
  `serviceName` varchar(255) NOT NULL,
  `userId` varchar(255) NOT NULL,
  `date` date NOT NULL,
  `time` varchar(255) NOT NULL,
  `status` enum('upcoming','completed','cancelled','pending','in-progress','scheduled') NOT NULL DEFAULT 'pending',
  `paymentStatus` enum('Paid','Unpaid') DEFAULT 'Unpaid',
  `therapistId` varchar(255) DEFAULT NULL,
  `notesForTherapist` text,
  `staffNotesAfterSession` text,
  `rejectionReason` text,
  `bookingGroupId` varchar(255) DEFAULT NULL,
  `promotionId` varchar(255) DEFAULT NULL COMMENT 'ID mã khuyến mãi/voucher được áp dụng',
  PRIMARY KEY (`id`),
  KEY `serviceId` (`serviceId`),
  KEY `userId` (`userId`),
  KEY `therapistId` (`therapistId`),
  KEY `date_time` (`date`,`time`),
  KEY `status` (`status`),
  KEY `promotionId` (`promotionId`),
  CONSTRAINT `appointments_ibfk_1` FOREIGN KEY (`serviceId`) REFERENCES `services` (`id`) ON DELETE CASCADE,
  CONSTRAINT `appointments_ibfk_2` FOREIGN KEY (`userId`) REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `appointments_ibfk_3` FOREIGN KEY (`therapistId`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `appointments_promotionId_fk` FOREIGN KEY (`promotionId`) REFERENCES `promotions` (`id`) ON DELETE SET NULL ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

DROP TABLE IF EXISTS `notifications`;
CREATE TABLE `notifications` (
  `id` varchar(255) NOT NULL,
  `userId` varchar(255) NOT NULL,
  `type` enum('new_appointment','appointment_confirmed','appointment_cancelled','appointment_reminder','treatment_course_reminder','promotion','payment_success','payment_received','system') NOT NULL DEFAULT 'system',
  `title` varchar(255) NOT NULL,
  `message` text NOT NULL,
  `relatedId` varchar(255) DEFAULT NULL COMMENT 'ID của appointment, treatment course, etc.',
  `isRead` tinyint(1) NOT NULL DEFAULT '0',
  `sentVia` enum('app','email','both') NOT NULL DEFAULT 'app',
  `emailSent` tinyint(1) NOT NULL DEFAULT '0',
  `createdAt` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `userId` (`userId`),
  CONSTRAINT `notifications_ibfk_1` FOREIGN KEY (`userId`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

DROP TABLE IF EXISTS `payments`;
CREATE TABLE `payments` (
  `id` varchar(255) NOT NULL,
  `transactionId` varchar(255) DEFAULT NULL,
  `userId` varchar(255) NOT NULL,
  `appointmentId` varchar(255) DEFAULT NULL,
  `serviceName` varchar(255) DEFAULT NULL,
  `amount` decimal(10,2) NOT NULL,
  `method` enum('Cash','Card','Momo','VNPay','ZaloPay') DEFAULT NULL,
  `status` enum('Completed','Pending','Refunded','Failed') NOT NULL DEFAULT 'Pending',
  `date` datetime NOT NULL,
  `therapistId` varchar(255) DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `userId` (`userId`),
  KEY `appointmentId` (`appointmentId`),
  KEY `therapistId` (`therapistId`),
  CONSTRAINT `payments_ibfk_1` FOREIGN KEY (`userId`) REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `payments_ibfk_2` FOREIGN KEY (`appointmentId`) REFERENCES `appointments` (`id`) ON DELETE SET NULL,
  CONSTRAINT `payments_ibfk_3` FOREIGN KEY (`therapistId`) REFERENCES `users` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

DROP TABLE IF EXISTS `promotion_usage`;
CREATE TABLE `promotion_usage` (
  `id` varchar(255) NOT NULL,
  `userId` varchar(255) NOT NULL,
  `promotionId` varchar(255) NOT NULL,
  `appointmentId` varchar(255) DEFAULT NULL,
  `serviceId` varchar(255) DEFAULT NULL COMMENT 'Service ID for New Clients promotion tracking',
  `usedAt` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `promotionId` (`promotionId`),
  KEY `appointmentId` (`appointmentId`),
  KEY `serviceId` (`serviceId`),
  KEY `promotion_usage_user_promo_idx` (`userId`,`promotionId`),
  KEY `promotion_usage_user_service_idx` (`userId`,`serviceId`),
  CONSTRAINT `promotion_usage_ibfk_1` FOREIGN KEY (`userId`) REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `promotion_usage_ibfk_2` FOREIGN KEY (`promotionId`) REFERENCES `promotions` (`id`) ON DELETE CASCADE,
  CONSTRAINT `promotion_usage_ibfk_3` FOREIGN KEY (`appointmentId`) REFERENCES `appointments` (`id`) ON DELETE SET NULL,
  CONSTRAINT `promotion_usage_ibfk_4` FOREIGN KEY (`serviceId`) REFERENCES `services` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

DROP TABLE IF EXISTS `promotions`;
CREATE TABLE `promotions` (
  `id` varchar(255) NOT NULL,
  `title` varchar(255) NOT NULL,
  `description` text NOT NULL,
  `code` varchar(255) NOT NULL,
  `expiryDate` date NOT NULL,
  `discountType` enum('percentage','fixed') NOT NULL,
  `discountValue` decimal(10,2) NOT NULL,
  `termsAndConditions` text,
  `targetAudience` enum('All','New Clients','Birthday','Group','VIP','Tier Level 1','Tier Level 2','Tier Level 3') DEFAULT 'All',
  `applicableServiceIds` json DEFAULT NULL,
  `minOrderValue` decimal(10,2) DEFAULT '0.00',
  `usageCount` int DEFAULT '0',
  `usageLimit` int DEFAULT NULL COMMENT 'NULL = không giới hạn',
  `stock` int DEFAULT NULL COMMENT 'Số lượng voucher còn lại (NULL = không giới hạn)',
  `isActive` tinyint(1) NOT NULL DEFAULT '1',
  `isPublic` tinyint(1) DEFAULT '1' COMMENT 'true = public (hiển thị trên trang khách hàng), false = private (chỉ dùng khi biết mã)',
  `pointsRequired` int DEFAULT NULL COMMENT 'Số điểm cần thiết để đổi voucher (chỉ áp dụng cho voucher private)',
  PRIMARY KEY (`id`),
  UNIQUE KEY `code` (`code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

DROP TABLE IF EXISTS `reviews`;
CREATE TABLE `reviews` (
  `id` varchar(255) NOT NULL,
  `serviceId` varchar(255) NOT NULL,
  `userId` varchar(255) NOT NULL,
  `appointmentId` varchar(255) DEFAULT NULL,
  `rating` int NOT NULL,
  `comment` text,
  `date` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `serviceId` (`serviceId`),
  KEY `userId` (`userId`),
  KEY `appointmentId` (`appointmentId`),
  CONSTRAINT `reviews_ibfk_1` FOREIGN KEY (`serviceId`) REFERENCES `services` (`id`) ON DELETE CASCADE,
  CONSTRAINT `reviews_ibfk_2` FOREIGN KEY (`userId`) REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `reviews_ibfk_3` FOREIGN KEY (`appointmentId`) REFERENCES `appointments` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

DROP TABLE IF EXISTS `sequelizemeta`;
CREATE TABLE `sequelizemeta` (
  `name` varchar(255) COLLATE utf8mb3_unicode_ci NOT NULL,
  PRIMARY KEY (`name`),
  UNIQUE KEY `name` (`name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `service_categories`;
CREATE TABLE `service_categories` (
  `id` int NOT NULL AUTO_INCREMENT,
  `name` varchar(255) NOT NULL,
  `description` text,
  `displayOrder` int DEFAULT '0',
  PRIMARY KEY (`id`),
  UNIQUE KEY `name` (`name`)
) ENGINE=InnoDB AUTO_INCREMENT=9 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

DROP TABLE IF EXISTS `services`;
CREATE TABLE `services` (
  `id` varchar(255) NOT NULL,
  `name` varchar(255) NOT NULL,
  `description` text NOT NULL,
  `price` decimal(10,2) NOT NULL,
  `discountPercent` int DEFAULT '0' COMMENT 'Phần trăm giảm giá (0-100)',
  `duration` int NOT NULL COMMENT 'Thời gian dịch vụ (phút)',
  `categoryId` int DEFAULT NULL,
  `imageUrl` longtext,
  `rating` float NOT NULL DEFAULT '0',
  `reviewCount` int NOT NULL DEFAULT '0',
  `isActive` tinyint(1) NOT NULL DEFAULT '1',
  PRIMARY KEY (`id`),
  KEY `categoryId` (`categoryId`),
  CONSTRAINT `services_ibfk_1` FOREIGN KEY (`categoryId`) REFERENCES `service_categories` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

DROP TABLE IF EXISTS `staff_availability`;
CREATE TABLE `staff_availability` (
  `id` varchar(255) NOT NULL,
  `staffId` varchar(255) NOT NULL,
  `date` date DEFAULT NULL COMMENT 'Ngày cụ thể (NULL nếu là lịch định kỳ)',
  `dayOfWeek` int DEFAULT NULL COMMENT 'Thứ trong tuần: 0=CN, 1=T2, ..., 6=T7 (NULL nếu là lịch cụ thể)',
  `startTime` varchar(10) DEFAULT NULL COMMENT 'Giờ bắt đầu (HH:MM) cho lịch định kỳ',
  `endTime` varchar(10) DEFAULT NULL COMMENT 'Giờ kết thúc (HH:MM) cho lịch định kỳ',
  `isAvailable` tinyint(1) DEFAULT '1' COMMENT 'Có sẵn sàng không (cho lịch định kỳ)',
  `timeSlots` json DEFAULT NULL COMMENT 'Mảng: [{time: "09:00", availableServiceIds: ["sv1", "sv2"]}] (cho lịch cụ thể)',
  PRIMARY KEY (`id`),
  KEY `staffId` (`staffId`),
  CONSTRAINT `staff_availability_ibfk_1` FOREIGN KEY (`staffId`) REFERENCES `users` (`id`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

DROP TABLE IF EXISTS `staff_shifts`;
CREATE TABLE `staff_shifts` (
  `id` varchar(255) NOT NULL,
  `staffId` varchar(255) NOT NULL,
  `date` date NOT NULL,
  `shiftType` enum('morning','afternoon','evening','leave','custom') NOT NULL,
  `status` enum('approved','pending','rejected') NOT NULL DEFAULT 'pending',
  `requestedBy` varchar(255) DEFAULT NULL,
  `notes` text,
  `assignedManagerId` varchar(255) DEFAULT NULL,
  `shiftHours` json DEFAULT NULL,
  `isUpForSwap` tinyint(1) DEFAULT '0',
  `swapClaimedBy` varchar(255) DEFAULT NULL,
  `managerApprovalStatus` enum('pending_approval','approved','rejected') DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `staffId` (`staffId`),
  KEY `assignedManagerId` (`assignedManagerId`),
  CONSTRAINT `staff_shifts_ibfk_1` FOREIGN KEY (`staffId`) REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `staff_shifts_ibfk_2` FOREIGN KEY (`assignedManagerId`) REFERENCES `users` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

DROP TABLE IF EXISTS `treatment_courses`;
CREATE TABLE `treatment_courses` (
  `id` varchar(255) NOT NULL,
  `serviceId` varchar(255) NOT NULL,
  `serviceName` varchar(255) NOT NULL COMMENT 'Tên dịch vụ',
  `clientId` varchar(255) NOT NULL,
  `totalSessions` int NOT NULL COMMENT 'Tổng số buổi (dựa trên số lượng khách chọn khi đặt lịch)',
  `completedSessions` int NOT NULL DEFAULT '0' COMMENT 'Số buổi đã hoàn thành',
  `startDate` date NOT NULL COMMENT 'Ngày bắt đầu (từ ngày đặt lịch)',
  `durationWeeks` int NOT NULL COMMENT 'Số tuần (mặc định: số dịch vụ + 1, admin có thể chỉnh)',
  `expiryDate` date NOT NULL COMMENT 'Hạn sử dụng (startDate + durationWeeks)',
  `frequencyType` enum('weeks_per_session','sessions_per_week') DEFAULT NULL COMMENT 'Loại tần suất: weeks_per_session = mấy tuần 1 lần, sessions_per_week = mấy lần 1 tuần',
  `frequencyValue` int DEFAULT NULL COMMENT 'Giá trị tần suất (ví dụ: 2 tuần 1 lần hoặc 2 lần/tuần)',
  `therapistId` varchar(255) DEFAULT NULL COMMENT 'ID nhân viên phụ trách',
  `status` enum('active','completed','expired','cancelled') NOT NULL DEFAULT 'active' COMMENT 'Trạng thái liệu trình',
  `paymentStatus` enum('Paid','Unpaid') NOT NULL DEFAULT 'Unpaid' COMMENT 'Trạng thái thanh toán (Đã thanh toán, Chưa thanh toán)',
  `notes` text COMMENT 'Ghi chú tổng quan',
  `createdAt` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Ngày tạo',
  `totalAmount` decimal(15,2) DEFAULT NULL COMMENT 'Tổng số tiền thực tế khi khách đặt lịch (sau khi áp dụng giảm giá/voucher)',
  PRIMARY KEY (`id`),
  KEY `idx_tc_service` (`serviceId`),
  KEY `idx_tc_client` (`clientId`),
  KEY `idx_tc_therapist` (`therapistId`),
  KEY `idx_tc_status` (`status`),
  KEY `idx_tc_expiry` (`expiryDate`),
  CONSTRAINT `treatment_courses_ibfk_1` FOREIGN KEY (`serviceId`) REFERENCES `services` (`id`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `treatment_courses_ibfk_2` FOREIGN KEY (`clientId`) REFERENCES `users` (`id`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `treatment_courses_ibfk_3` FOREIGN KEY (`therapistId`) REFERENCES `users` (`id`) ON DELETE SET NULL ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

DROP TABLE IF EXISTS `treatment_sessions`;
CREATE TABLE `treatment_sessions` (
  `id` varchar(255) NOT NULL,
  `treatmentCourseId` varchar(255) NOT NULL COMMENT 'ID liệu trình',
  `appointmentId` varchar(255) DEFAULT NULL COMMENT 'ID lịch hẹn (liên kết với appointments)',
  `sessionNumber` int NOT NULL COMMENT 'Số thứ tự buổi (1, 2, 3, ...)',
  `status` enum('scheduled','completed','cancelled','missed') NOT NULL DEFAULT 'scheduled' COMMENT 'Trạng thái buổi điều trị',
  `sessionDate` date NOT NULL COMMENT 'Ngày thực hiện',
  `sessionTime` varchar(10) NOT NULL COMMENT 'Giờ thực hiện (HH:MM)',
  `staffId` varchar(255) DEFAULT NULL COMMENT 'ID nhân viên thực hiện',
  `customerStatusNotes` text COMMENT 'Ghi chú tình trạng khách (TEXT, không phải ENUM) - Ví dụ: "Khách ổn, da sáng hơn, không có kích ứng"',
  `adminNotes` text COMMENT 'Ghi chú của admin sau buổi',
  `completedAt` datetime DEFAULT NULL COMMENT 'Ngày hoàn thành',
  PRIMARY KEY (`id`),
  KEY `idx_ts_course` (`treatmentCourseId`),
  KEY `idx_ts_appointment` (`appointmentId`),
  KEY `idx_ts_staff` (`staffId`),
  KEY `idx_ts_date` (`sessionDate`),
  KEY `idx_ts_status` (`status`),
  CONSTRAINT `treatment_sessions_ibfk_1` FOREIGN KEY (`treatmentCourseId`) REFERENCES `treatment_courses` (`id`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `treatment_sessions_ibfk_2` FOREIGN KEY (`appointmentId`) REFERENCES `appointments` (`id`) ON DELETE SET NULL ON UPDATE CASCADE,
  CONSTRAINT `treatment_sessions_ibfk_3` FOREIGN KEY (`staffId`) REFERENCES `users` (`id`) ON DELETE SET NULL ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

DROP TABLE IF EXISTS `users`;
CREATE TABLE `users` (
  `id` varchar(255) NOT NULL,
  `name` varchar(255) NOT NULL,
  `email` varchar(255) NOT NULL,
  `password` varchar(255) NOT NULL,
  `phone` varchar(255) DEFAULT NULL,
  `profilePictureUrl` varchar(255) DEFAULT NULL,
  `joinDate` date NOT NULL,
  `birthday` date DEFAULT NULL,
  `gender` varchar(255) DEFAULT NULL,
  `role` enum('Admin','Staff','Client') NOT NULL DEFAULT 'Client',
  `status` enum('Active','Inactive','Locked','Pending') NOT NULL DEFAULT 'Active',
  `lastLogin` datetime DEFAULT NULL,
  `emailVerificationToken` varchar(255) DEFAULT NULL,
  `isEmailVerified` tinyint(1) NOT NULL DEFAULT '0',
  `passwordResetToken` varchar(255) DEFAULT NULL,
  `passwordResetTokenExpires` datetime DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `email` (`email`),
  UNIQUE KEY `emailVerificationToken` (`emailVerificationToken`),
  UNIQUE KEY `passwordResetToken` (`passwordResetToken`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

DROP TABLE IF EXISTS `wallets`;
CREATE TABLE `wallets` (
  `id` varchar(255) NOT NULL,
  `userId` varchar(255) NOT NULL,
  `points` int NOT NULL DEFAULT '0',
  `tierLevel` int NOT NULL DEFAULT '1' COMMENT 'Hạng thành viên (1-8)',
  `totalSpent` decimal(10,2) NOT NULL DEFAULT '0.00',
  `lastUpdated` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `userId` (`userId`),
  CONSTRAINT `wallets_ibfk_1` FOREIGN KEY (`userId`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;