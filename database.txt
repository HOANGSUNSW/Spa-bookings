-- =========================================================
-- DATABASE SETUP SCRIPT FOR ANH THƠ SPA MANAGEMENT SYSTEM
-- MySQL Database Schema với Foreign Keys và Sample Data
-- =========================================================

-- Tạo database (nếu chưa tồn tại)
CREATE DATABASE IF NOT EXISTS anhthospa_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE anhthospa_db;

-- =========================================================
-- 1. TẠO CÁC BẢNG CƠ BẢN (KHÔNG CÓ FOREIGN KEYS)
-- =========================================================

-- 1.1. Bảng Users (Người dùng)
CREATE TABLE IF NOT EXISTS users (
    id VARCHAR(255) PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    email VARCHAR(255) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    phone VARCHAR(50),
    profilePictureUrl TEXT,
    joinDate DATE NOT NULL,
    birthday DATE,
    gender VARCHAR(50),
    role ENUM('Admin', 'Staff', 'Client') NOT NULL DEFAULT 'Client',
    status ENUM('Active', 'Inactive', 'Locked') NOT NULL DEFAULT 'Active',
    lastLogin DATETIME,
    loginHistory JSON,
    roomId VARCHAR(255),
    INDEX idx_users_email (email),
    INDEX idx_users_role (role)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 1.2. Bảng Rooms (Phòng điều trị)
CREATE TABLE IF NOT EXISTS rooms (
    id VARCHAR(255) PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    capacity INT NOT NULL DEFAULT 1,
    equipmentIds JSON,
    isActive BOOLEAN NOT NULL DEFAULT TRUE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 1.3. Bảng Service Categories (Danh mục dịch vụ)
CREATE TABLE IF NOT EXISTS service_categories (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255) NOT NULL UNIQUE,
    description TEXT,
    displayOrder INT DEFAULT 0
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- =========================================================
-- 2. TẠO CÁC BẢNG CÓ FOREIGN KEYS
-- =========================================================

-- 2.1. Bảng Services (Dịch vụ)
CREATE TABLE IF NOT EXISTS services (
    id VARCHAR(255) PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description TEXT NOT NULL,
    longDescription TEXT,
    price DECIMAL(10, 2) NOT NULL,
    discountPercent INT DEFAULT 0,
    duration INT NOT NULL COMMENT 'Thời gian dịch vụ (phút)',
    category VARCHAR(255) COMMENT 'Tên danh mục (để hiển thị)',
    categoryId INT,
    imageUrl VARCHAR(500),
    rating FLOAT DEFAULT 0,
    reviewCount INT DEFAULT 0,
    isActive BOOLEAN NOT NULL DEFAULT TRUE,
    popularity INT DEFAULT 0,
    benefits JSON,
    suitableFor JSON,
    process JSON,
    FOREIGN KEY (categoryId) REFERENCES service_categories(id) ON DELETE SET NULL ON UPDATE CASCADE,
    INDEX idx_services_category (categoryId),
    INDEX idx_services_name (name)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 2.2. Bảng Appointments (Lịch hẹn)
CREATE TABLE IF NOT EXISTS appointments (
    id VARCHAR(255) PRIMARY KEY,
    serviceId VARCHAR(255) NOT NULL,
    serviceName VARCHAR(255) NOT NULL,
    userId VARCHAR(255) NOT NULL,
    userName VARCHAR(255) COMMENT 'Tên khách hàng (để hiển thị trên lịch)',
    date DATE NOT NULL,
    time VARCHAR(20) NOT NULL,
    status ENUM('upcoming', 'completed', 'cancelled', 'pending', 'in-progress', 'scheduled') NOT NULL DEFAULT 'pending',
    paymentStatus ENUM('Paid', 'Unpaid') DEFAULT 'Unpaid',
    therapist VARCHAR(255),
    therapistId VARCHAR(255),
    roomId VARCHAR(255),
    notesForTherapist TEXT,
    staffNotesAfterSession TEXT,
    isStarted BOOLEAN DEFAULT FALSE,
    isCompleted BOOLEAN DEFAULT FALSE,
    reviewRating INT,
    rejectionReason TEXT,
    bookingGroupId VARCHAR(255),
    treatmentCourseId VARCHAR(255),
    treatmentSessionId VARCHAR(255),
    FOREIGN KEY (serviceId) REFERENCES services(id) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (userId) REFERENCES users(id) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (therapistId) REFERENCES users(id) ON DELETE SET NULL ON UPDATE CASCADE,
    FOREIGN KEY (roomId) REFERENCES rooms(id) ON DELETE SET NULL ON UPDATE CASCADE,
    INDEX idx_app_user_date (userId, date),
    INDEX idx_app_therapist_date (therapistId, date),
    INDEX idx_app_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 2.3. Bảng Payments (Thanh toán)
CREATE TABLE IF NOT EXISTS payments (
    id VARCHAR(255) PRIMARY KEY,
    transactionId VARCHAR(255),
    bookingId VARCHAR(255),
    userId VARCHAR(255) NOT NULL,
    appointmentId VARCHAR(255),
    serviceName VARCHAR(255),
    amount DECIMAL(10, 2) NOT NULL,
    method ENUM('Cash', 'Card', 'Momo', 'VNPay', 'ZaloPay'),
    status ENUM('Completed', 'Pending', 'Refunded', 'Failed') NOT NULL DEFAULT 'Pending',
    date DATETIME NOT NULL,
    therapistId VARCHAR(255),
    FOREIGN KEY (userId) REFERENCES users(id) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (appointmentId) REFERENCES appointments(id) ON DELETE SET NULL ON UPDATE CASCADE,
    FOREIGN KEY (therapistId) REFERENCES users(id) ON DELETE SET NULL ON UPDATE CASCADE,
    INDEX idx_pay_date (date),
    INDEX idx_pay_user (userId)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 2.4. Bảng Wallets (Ví điện tử)
CREATE TABLE IF NOT EXISTS wallets (
    id VARCHAR(255) PRIMARY KEY,
    userId VARCHAR(255) NOT NULL UNIQUE,
    balance DECIMAL(10, 2) NOT NULL DEFAULT 0.00,
    points INT NOT NULL DEFAULT 0,
    tierLevel INT NOT NULL DEFAULT 1 COMMENT 'Hạng thành viên (1-8)',
    totalSpent DECIMAL(10, 2) NOT NULL DEFAULT 0.00,
    totalEarned INT NOT NULL DEFAULT 0 COMMENT 'Tổng điểm đã tích được',
    totalSpentPoints INT NOT NULL DEFAULT 0 COMMENT 'Tổng điểm đã sử dụng',
    pointsHistory JSON COMMENT 'Lịch sử điểm: [{date, pointsChange, type, source, description}]',
    lastUpdated DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (userId) REFERENCES users(id) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 2.5. Bảng Promotions (Khuyến mãi)
CREATE TABLE IF NOT EXISTS promotions (
    id VARCHAR(255) PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    description TEXT NOT NULL,
    code VARCHAR(255) NOT NULL UNIQUE,
    expiryDate DATE NOT NULL,
    imageUrl VARCHAR(500),
    discountType ENUM('percentage', 'fixed') NOT NULL,
    discountValue DECIMAL(10, 2) NOT NULL,
    termsAndConditions TEXT,
    targetAudience ENUM('All', 'New Clients', 'Birthday', 'Group', 'VIP',
        'Tier Level 1', 'Tier Level 2', 'Tier Level 3', 'Tier Level 4',
        'Tier Level 5', 'Tier Level 6', 'Tier Level 7', 'Tier Level 8') DEFAULT 'All',
    applicableServiceIds JSON,
    minOrderValue DECIMAL(10, 2) DEFAULT 0.00,
    usageCount INT DEFAULT 0,
    usageLimit INT COMMENT 'NULL = không giới hạn',
    pointsRequired INT DEFAULT 0 COMMENT 'Điểm cần để đổi (0 = không cần)',
    isVoucher BOOLEAN DEFAULT FALSE,
    isActive BOOLEAN NOT NULL DEFAULT TRUE,
    INDEX idx_promo_code (code),
    INDEX idx_promo_active (isActive)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 2.6. Bảng Reviews (Đánh giá)
CREATE TABLE IF NOT EXISTS reviews (
    id VARCHAR(255) PRIMARY KEY,
    serviceId VARCHAR(255) NOT NULL,
    userId VARCHAR(255) NOT NULL,
    appointmentId VARCHAR(255) UNIQUE,
    rating INT NOT NULL CHECK (rating >= 1 AND rating <= 5),
    comment TEXT,
    date DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    managerReply TEXT,
    FOREIGN KEY (serviceId) REFERENCES services(id) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (userId) REFERENCES users(id) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (appointmentId) REFERENCES appointments(id) ON DELETE SET NULL ON UPDATE CASCADE,
    INDEX idx_review_service (serviceId),
    INDEX idx_review_user (userId)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 2.7. Bảng Treatment Packages (Gói điều trị mẫu)
CREATE TABLE IF NOT EXISTS treatment_packages (
    id VARCHAR(255) PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    price DECIMAL(10, 2) NOT NULL,
    totalSessions INT NOT NULL,
    sessionsPerWeek INT DEFAULT 1,
    weekDays JSON COMMENT 'Mảng các thứ trong tuần: [1,3,5]',
    sessionDuration INT DEFAULT 60 COMMENT 'Thời gian mỗi buổi (phút)',
    imageUrl VARCHAR(500),
    isActive BOOLEAN NOT NULL DEFAULT TRUE,
    createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,
    updatedAt DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 2.8. Bảng Treatment Package Services (Junction table)
CREATE TABLE IF NOT EXISTS treatment_package_services (
    id VARCHAR(255) PRIMARY KEY,
    treatmentPackageId VARCHAR(255) NOT NULL,
    serviceId VARCHAR(255) NOT NULL,
    sessionNumber INT NOT NULL COMMENT 'Số thứ tự buổi trong gói',
    FOREIGN KEY (treatmentPackageId) REFERENCES treatment_packages(id) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (serviceId) REFERENCES services(id) ON DELETE CASCADE ON UPDATE CASCADE,
    UNIQUE KEY unique_package_service (treatmentPackageId, serviceId, sessionNumber)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 2.9. Bảng Treatment Courses (Liệu trình điều trị)
CREATE TABLE IF NOT EXISTS treatment_courses (
    id VARCHAR(255) PRIMARY KEY,
    templateId VARCHAR(255) COMMENT 'ID của template liệu trình',
    name VARCHAR(255) NOT NULL COMMENT 'Tên gói liệu trình',
    price DECIMAL(10, 2) NOT NULL,
    packageId VARCHAR(255) COMMENT 'ID của gói liệu trình mẫu',
    serviceId VARCHAR(255) COMMENT 'DEPRECATED: Use treatment_course_services instead',
    serviceName VARCHAR(255) COMMENT 'DEPRECATED',
    totalSessions INT NOT NULL,
    sessionsPerWeek INT NOT NULL DEFAULT 1,
    weekDays JSON COMMENT 'Mảng các thứ trong tuần: [1,3,5]',
    sessionDuration INT NOT NULL DEFAULT 60 COMMENT 'Thời gian mỗi buổi (phút)',
    sessionTime VARCHAR(20) COMMENT 'Giờ cố định cho các buổi (ví dụ: "18:00")',
    description TEXT,
    imageUrl VARCHAR(500),
    sessions JSON COMMENT 'Mảng các session dạng JSON',
    initialAppointmentId VARCHAR(255),
    clientId VARCHAR(255),
    therapistId VARCHAR(255),
    status ENUM('draft', 'active', 'paused', 'completed', 'expired', 'cancelled') NOT NULL DEFAULT 'active',
    expiryDate DATE,
    nextAppointmentDate DATE COMMENT 'Ngày hẹn tiếp theo',
    progressPercentage INT NOT NULL DEFAULT 0 COMMENT 'Phần trăm hoàn thành (0-100)',
    completedSessions INT NOT NULL DEFAULT 0,
    lastCompletedDate DATETIME,
    treatmentGoals TEXT COMMENT 'Mục tiêu điều trị',
    initialSkinCondition TEXT COMMENT 'Tình trạng da ban đầu',
    consultantId VARCHAR(255),
    consultantName VARCHAR(255),
    isPaused BOOLEAN NOT NULL DEFAULT FALSE,
    pauseReason TEXT,
    pausedDate DATETIME,
    resumedDate DATETIME,
    startDate DATE,
    actualCompletionDate DATETIME,
    remindersSent JSON DEFAULT '[]' COMMENT 'Lịch sử các reminder đã gửi',
    createdAt DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updatedAt DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (packageId) REFERENCES treatment_packages(id) ON DELETE SET NULL ON UPDATE CASCADE,
    FOREIGN KEY (serviceId) REFERENCES services(id) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (initialAppointmentId) REFERENCES appointments(id) ON DELETE SET NULL ON UPDATE CASCADE,
    FOREIGN KEY (clientId) REFERENCES users(id) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (therapistId) REFERENCES users(id) ON DELETE SET NULL ON UPDATE CASCADE,
    INDEX idx_tc_client (clientId),
    INDEX idx_tc_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 2.10. Bảng Treatment Course Services (Junction table)
CREATE TABLE IF NOT EXISTS treatment_course_services (
    id VARCHAR(255) PRIMARY KEY,
    treatmentCourseId VARCHAR(255) NOT NULL,
    serviceId VARCHAR(255) NOT NULL,
    sessionNumber INT NOT NULL COMMENT 'Số thứ tự buổi trong liệu trình',
    FOREIGN KEY (treatmentCourseId) REFERENCES treatment_courses(id) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (serviceId) REFERENCES services(id) ON DELETE CASCADE ON UPDATE CASCADE,
    UNIQUE KEY unique_course_service (treatmentCourseId, serviceId, sessionNumber)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 2.11. Bảng Notifications (Thông báo)
CREATE TABLE IF NOT EXISTS notifications (
    id VARCHAR(255) PRIMARY KEY,
    userId VARCHAR(255),
    type ENUM('appointment_new', 'appointment_cancelled', 'shift_change', 'admin_message', 'promo_alert', 'system_news', 'client_feedback') NOT NULL,
    message TEXT NOT NULL,
    isRead BOOLEAN NOT NULL DEFAULT FALSE,
    date DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    link TEXT,
    FOREIGN KEY (userId) REFERENCES users(id) ON DELETE CASCADE ON UPDATE CASCADE,
    INDEX idx_notif_user (userId),
    INDEX idx_notif_read (isRead)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 2.12. Bảng Staff Shifts (Ca làm việc)
CREATE TABLE IF NOT EXISTS staff_shifts (
    id VARCHAR(255) PRIMARY KEY,
    staffId VARCHAR(255) NOT NULL,
    date DATE NOT NULL,
    shiftType ENUM('morning', 'afternoon', 'evening', 'leave', 'custom') NOT NULL,
    status ENUM('approved', 'pending', 'rejected') DEFAULT 'pending',
    requestedBy VARCHAR(255),
    notes TEXT,
    assignedManagerId VARCHAR(255),
    shiftHours JSON,
    isUpForSwap BOOLEAN DEFAULT FALSE,
    swapClaimedBy VARCHAR(255),
    managerApprovalStatus ENUM('pending_approval', 'approved', 'rejected'),
    room VARCHAR(255),
    FOREIGN KEY (staffId) REFERENCES users(id) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (assignedManagerId) REFERENCES users(id) ON DELETE SET NULL ON UPDATE CASCADE,
    INDEX idx_shift_staff_date (staffId, date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 2.13. Bảng Staff Tasks (Công việc nhân viên)
CREATE TABLE IF NOT EXISTS staff_tasks (
    id VARCHAR(255) PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    assignedToId VARCHAR(255) NOT NULL,
    assignedById VARCHAR(255) NOT NULL,
    dueDate DATE NOT NULL,
    status ENUM('pending', 'in-progress', 'completed', 'overdue') NOT NULL,
    priority ENUM('low', 'medium', 'high') NOT NULL,
    createdAt DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    completedAt DATETIME,
    FOREIGN KEY (assignedToId) REFERENCES users(id) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (assignedById) REFERENCES users(id) ON DELETE CASCADE ON UPDATE CASCADE,
    INDEX idx_tasks_assigned_to (assignedToId),
    INDEX idx_tasks_due_date (dueDate)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 2.14. Thêm Foreign Key cho Users.roomId
ALTER TABLE users
ADD CONSTRAINT fk_users_room
FOREIGN KEY (roomId) REFERENCES rooms(id) ON DELETE SET NULL ON UPDATE CASCADE;

-- =========================================================
-- 3. INSERT DỮ LIỆU MẪU
-- =========================================================

-- 3.1. Insert Service Categories
INSERT INTO service_categories (id, name, description, displayOrder) VALUES
(1, 'Massage', 'Các dịch vụ massage thư giãn', 1),
(2, 'Skincare', 'Chăm sóc da mặt', 2),
(3, 'Body Care', 'Chăm sóc cơ thể', 3),
(4, 'Relax', 'Thư giãn', 4),
(5, 'Spa Package', 'Gói dịch vụ spa', 5),
(6, 'Triệt Lông', 'Dịch vụ triệt lông', 6),
(7, 'Clinic', 'Dịch vụ clinic', 7),
(8, 'Nail', 'Chăm sóc móng', 8),
(9, 'Khác', 'Các dịch vụ khác', 9)
ON DUPLICATE KEY UPDATE name=VALUES(name);

-- 3.2. Insert Rooms
INSERT INTO rooms (id, name, capacity, isActive) VALUES
('room-001', 'Phòng VIP 1', 1, TRUE),
('room-002', 'Phòng VIP 2', 1, TRUE),
('room-003', 'Phòng Standard 1', 1, TRUE),
('room-004', 'Phòng Standard 2', 1, TRUE),
('room-005', 'Phòng Massage', 2, TRUE)
ON DUPLICATE KEY UPDATE name=VALUES(name);

-- 3.3. Insert Users (Mật khẩu: password123 - đã hash bằng bcrypt)
-- Lưu ý: Trong thực tế, mật khẩu phải được hash bằng bcrypt trước khi insert
INSERT INTO users (id, name, email, password, phone, profilePictureUrl, joinDate, birthday, gender, role, status, lastLogin) VALUES
('user-admin', 'Trần Thị Hạnh', 'admin@spa.vn', '$2a$10$e.x2V.OMi1G0UB.2yP89bu4xQJ.Go.1V1UahvMKx7JqopIm7VBH.G', '0901112233', 'https://picsum.photos/seed/U001/200', '2024-01-05', '1992-02-10', 'Nữ', 'Admin', 'Active', NOW()),
('user-manager', 'Nguyễn Quang Minh', 'manager@spa.vn', '$2a$10$e.x2V.OMi1G0UB.2yP89bu4xQJ.Go.1V1UahvMKx7JqopIm7VBH.G', '0908889999', 'https://picsum.photos/seed/U002/200', '2024-01-20', '1990-03-14', 'Nam', 'Staff', 'Active', NOW()),
('user-tech-1', 'Lê Phương Anh', 'tech1@spa.vn', '$2a$10$e.x2V.OMi1G0UB.2yP89bu4xQJ.Go.1V1UahvMKx7JqopIm7VBH.G', '0907778888', 'https://picsum.photos/seed/U003/200', '2024-02-01', '1995-06-20', 'Nữ', 'Staff', 'Active', NOW()),
('user-tech-2', 'Phạm Văn Tài', 'tech2@spa.vn', '$2a$10$e.x2V.OMi1G0UB.2yP89bu4xQJ.Go.1V1UahvMKx7JqopIm7VBH.G', '0903334444', 'https://picsum.photos/seed/U004/200', '2024-02-10', '1994-09-25', 'Nam', 'Staff', 'Active', NOW()),
('user-recep-1', 'Trần Bích Ngọc', 'recep1@spa.vn', '$2a$10$e.x2V.OMi1G0UB.2yP89bu4xQJ.Go.1V1UahvMKx7JqopIm7VBH.G', '0905556666', 'https://picsum.photos/seed/U005/200', '2024-03-02', '1998-12-12', 'Nữ', 'Staff', 'Active', NOW()),
('user-client-1', 'Nguyễn Thu Hằng', 'client1@spa.vn', '$2a$10$e.x2V.OMi1G0UB.2yP89bu4xQJ.Go.1V1UahvMKx7JqopIm7VBH.G', '0900001111', 'https://picsum.photos/seed/C001/200', '2024-03-15', '1996-07-21', 'Nữ', 'Client', 'Active', '2024-07-20 10:00:00'),
('user-client-2', 'Lưu Hữu Nam', 'client2@spa.vn', '$2a$10$e.x2V.OMi1G0UB.2yP89bu4xQJ.Go.1V1UahvMKx7JqopIm7VBH.G', '0901112222', 'https://picsum.photos/seed/C002/200', '2024-04-01', '1998-10-02', 'Nam', 'Client', 'Active', NOW()),
('user-client-3', 'Phan Mai Chi', 'client3@spa.vn', '$2a$10$e.x2V.OMi1G0UB.2yP89bu4xQJ.Go.1V1UahvMKx7JqopIm7VBH.G', '0902223333', 'https://picsum.photos/seed/C003/200', '2024-05-12', '2000-05-05', 'Nữ', 'Client', 'Active', NOW())
ON DUPLICATE KEY UPDATE name=VALUES(name);

-- 3.4. Insert Wallets
INSERT INTO wallets (id, userId, balance, points, tierLevel, totalSpent, totalEarned, totalSpentPoints) VALUES
('wallet-001', 'user-client-1', 900000.00, 90, 1, 900000.00, 90, 0),
('wallet-002', 'user-client-2', 2200000.00, 220, 2, 2200000.00, 220, 0),
('wallet-003', 'user-client-3', 5500000.00, 550, 3, 5500000.00, 550, 0)
ON DUPLICATE KEY UPDATE balance=VALUES(balance), points=VALUES(points);

-- 3.5. Insert Services
INSERT INTO services (id, name, description, longDescription, price, discountPercent, duration, categoryId, category, imageUrl, rating, reviewCount, isActive) VALUES
('svc-facial-basic', 'Chăm sóc da mặt cơ bản', 'Làm sạch sâu, cấp ẩm cho da.', 'Liệu trình làm sạch sâu, loại bỏ bụi bẩn, tế bào chết và cung cấp độ ẩm cần thiết, mang lại làn da tươi sáng và mịn màng.', 500000, 0, 60, 2, 'Skincare', 'https://picsum.photos/seed/facial-basic/400/300', 4.8, 120, TRUE),
('svc-massage-body', 'Massage body thảo dược', 'Thư giãn toàn thân, giảm căng thẳng.', 'Sử dụng các loại thảo dược tự nhiên kết hợp kỹ thuật massage chuyên nghiệp giúp giảm căng cơ, lưu thông khí huyết và thư giãn tinh thần.', 700000, 15, 90, 1, 'Massage', 'https://picsum.photos/seed/massage-body/400/300', 4.9, 250, TRUE),
('svc-hair-removal', 'Triệt lông nách Diode Laser', 'Triệt lông vĩnh viễn, an toàn.', 'Công nghệ Diode Laser hiện đại giúp loại bỏ lông tận gốc, an toàn cho da, không đau rát và mang lại hiệu quả lâu dài.', 800000, 0, 30, 6, 'Triệt Lông', 'https://picsum.photos/seed/hair-removal/400/300', 4.7, 95, TRUE),
('svc-combo-relax', 'Gói Thư Giãn Toàn Diện', 'Combo massage body và chăm sóc da mặt chuyên sâu.', 'Trải nghiệm gói dịch vụ kết hợp hoàn hảo giữa 90 phút massage body thảo dược giúp xua tan mệt mỏi và 60 phút chăm sóc da mặt cơ bản, mang lại sự thư thái từ trong ra ngoài.', 1200000, 17, 150, 5, 'Spa Package', 'https://picsum.photos/seed/combo-relax/400/300', 4.9, 75, TRUE),
('svc-combo-detox', 'Gói Thanh Lọc & Tái Tạo Da', 'Kết hợp xông hơi thải độc và liệu trình cấy tảo xoắn.', 'Gói dịch vụ thanh lọc cơ thể toàn diện với xông hơi thảo dược giúp đào thải độc tố, kết hợp cùng liệu trình cấy tảo xoắn trẻ hóa làn da, mang lại vẻ ngoài rạng rỡ và đầy sức sống.', 1500000, 20, 120, 5, 'Spa Package', 'https://picsum.photos/seed/combo-detox/400/300', 4.8, 45, TRUE),
('svc-combo-royal', 'Gói Chăm Sóc Toàn Thân Hoàng Gia', 'Trải nghiệm đẳng cấp hoàng gia với tẩy tế bào chết, ủ dưỡng thể và massage đá nóng.', 'Một liệu trình sang trọng bao gồm tẩy tế bào chết toàn thân bằng cafe, ủ dưỡng thể collagen vàng 24k và kết thúc bằng 90 phút massage thư giãn với đá nóng Himalaya, mang lại làn da mịn màng và tinh thần sảng khoái.', 2500000, 20, 180, 5, 'Spa Package', 'https://picsum.photos/seed/combo-royal/400/300', 5.0, 30, TRUE)
ON DUPLICATE KEY UPDATE name=VALUES(name), price=VALUES(price);

-- 3.6. Insert Promotions
INSERT INTO promotions (id, title, description, code, expiryDate, imageUrl, discountType, discountValue, termsAndConditions, targetAudience, isActive) VALUES
('promo-1', 'Giảm 20% cho dịch vụ Facial', 'Ưu đãi đặc biệt cho tất cả các dịch vụ chăm sóc da mặt.', 'FACIAL20', '2024-12-31', 'https://picsum.photos/seed/promo-facial/500/300', 'percentage', 20, 'Áp dụng cho tất cả khách hàng.', 'All', TRUE),
('promo-2', 'Giảm 100.000đ cho đơn hàng trên 1.000.000đ', 'Giảm giá cố định cho đơn hàng lớn.', 'SAVE100K', '2024-12-31', 'https://picsum.photos/seed/promo-save/500/300', 'fixed', 100000, 'Áp dụng cho đơn hàng từ 1.000.000đ trở lên.', 'All', TRUE)
ON DUPLICATE KEY UPDATE title=VALUES(title), code=VALUES(code);

-- 3.7. Insert Appointments
INSERT INTO appointments (id, serviceId, serviceName, userId, userName, date, time, status, paymentStatus, therapistId, therapist, roomId) VALUES
('apt-1', 'svc-facial-basic', 'Chăm sóc da mặt cơ bản', 'user-client-1', 'Nguyễn Thu Hằng', '2024-07-28', '10:00', 'completed', 'Paid', 'user-tech-1', 'Lê Phương Anh', 'room-001'),
('apt-2', 'svc-massage-body', 'Massage body thảo dược', 'user-client-2', 'Lưu Hữu Nam', '2024-08-05', '14:00', 'upcoming', 'Unpaid', 'user-tech-2', 'Phạm Văn Tài', 'room-002')
ON DUPLICATE KEY UPDATE status=VALUES(status);

-- 3.8. Insert Payments
INSERT INTO payments (id, transactionId, userId, appointmentId, serviceName, amount, method, status, date, therapistId) VALUES
('pay-1', 'TXN-001', 'user-client-1', 'apt-1', 'Chăm sóc da mặt cơ bản', 500000, 'Cash', 'Completed', '2024-07-28 10:30:00', 'user-tech-1'),
('pay-2', 'TXN-002', 'user-client-2', 'apt-2', 'Massage body thảo dược', 595000, 'VNPay', 'Pending', '2024-08-05 14:00:00', 'user-tech-2')
ON DUPLICATE KEY UPDATE status=VALUES(status);

-- 3.9. Insert Reviews
INSERT INTO reviews (id, serviceId, userId, appointmentId, rating, comment, date) VALUES
('rev-1', 'svc-facial-basic', 'user-client-1', 'apt-1', 5, 'Dịch vụ rất tốt, nhân viên nhiệt tình.', '2024-07-29 00:00:00')
ON DUPLICATE KEY UPDATE rating=VALUES(rating);

-- =========================================================
-- 4. TẠO INDEXES BỔ SUNG ĐỂ TỐI ƯU PERFORMANCE
-- =========================================================

-- Indexes đã được tạo trong các câu lệnh CREATE TABLE ở trên
-- Có thể thêm indexes bổ sung nếu cần:

-- CREATE INDEX idx_appointments_date_status ON appointments(date, status);
-- CREATE INDEX idx_payments_user_status ON payments(userId, status);
-- CREATE INDEX idx_treatment_courses_client_status ON treatment_courses(clientId, status);

-- =========================================================
-- 5. VERIFY DATABASE SETUP
-- =========================================================

-- Kiểm tra số lượng records trong mỗi bảng
SELECT 'users' AS table_name, COUNT(*) AS record_count FROM users
UNION ALL
SELECT 'services', COUNT(*) FROM services
UNION ALL
SELECT 'appointments', COUNT(*) FROM appointments
UNION ALL
SELECT 'payments', COUNT(*) FROM payments
UNION ALL
SELECT 'wallets', COUNT(*) FROM wallets
UNION ALL
SELECT 'promotions', COUNT(*) FROM promotions
UNION ALL
SELECT 'reviews', COUNT(*) FROM reviews
UNION ALL
SELECT 'rooms', COUNT(*) FROM rooms
UNION ALL
SELECT 'service_categories', COUNT(*) FROM service_categories;

-- =========================================================
-- LƯU Ý QUAN TRỌNG:
-- =========================================================
-- 1. Mật khẩu trong bảng users phải được hash bằng bcrypt trước khi insert
-- 2. Tất cả các bảng sử dụng ENGINE=InnoDB để hỗ trợ Foreign Keys
-- 3. Charset utf8mb4 để hỗ trợ emoji và ký tự đặc biệt
-- 4. ON DUPLICATE KEY UPDATE được sử dụng để tránh lỗi khi chạy lại script
-- 5. Foreign Keys có ON DELETE và ON UPDATE actions phù hợp
-- 6. Indexes được tạo trên các trường thường query để tối ưu performance
-- =========================================================

